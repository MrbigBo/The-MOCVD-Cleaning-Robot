
/**************************************
 * 文件名  ：main.c
 * 描述    ：通过串口调试软件，向板子发送数据，板子接收到数据后，立即回传给电脑。         
 * 实验平台：MINI STM32开发板 基于STM32F103C8T6
 * 库版本  ：ST3.0.0  																										  

*********************************************************/
#include "stm32f10x_sdio.h"
#include "stm32f10x.h"
#include "usart1.h"
#include "message.h"
#include "ikunc.h"
#include "Site.h"

float slte[][3] = {
{	0.804 	,	0.096 	,	1.504 	}	,
{	0.774 	,	0.091 	,	1.504 	}	,
{	0.748 	,	0.078 	,	1.504 	}	,
{	0.726 	,	0.056 	,	1.504 	}	,
{	0.713 	,	0.030 	,	1.504 	}	,
{	0.708 	,	0.000 	,	1.504 	}	,
{	0.713 	,	-0.030 	,	1.504 	}	,
{	0.726 	,	-0.056 	,	1.504 	}	,
{	0.748 	,	-0.078 	,	1.504 	}	,
{	0.774 	,	-0.091 	,	1.504 	}	,
{	0.804 	,	-0.096 	,	1.504 	}	,
{	0.834 	,	-0.091 	,	1.504 	}	,
{	0.860 	,	-0.078 	,	1.504 	}	,
{	0.882 	,	-0.056 	,	1.504 	}	,
{	0.895 	,	-0.030 	,	1.504 	}	,
{	0.900 	,	0.000 	,	1.504 	}	,
{	0.895 	,	0.030 	,	1.504 	}	,
{	0.882 	,	0.056 	,	1.504 	}	,
{	0.860 	,	0.078 	,	1.504 	}	,
{	0.834 	,	0.091 	,	1.504 	}	,
{	0.804 	,	0.096 	,	1.504 	}	,
{	0.804 	,	0.048 	,	1.504 	}	,
{	0.789 	,	0.046 	,	1.504 	}	,
{	0.776 	,	0.039 	,	1.504 	}	,
{	0.765 	,	0.028 	,	1.504 	}	,
{	0.758 	,	0.015 	,	1.504 	}	,
{	0.756 	,	0.000 	,	1.504 	}	,
{	0.758 	,	-0.015 	,	1.504 	}	,
{	0.765 	,	-0.028 	,	1.504 	}	,
{	0.776 	,	-0.039 	,	1.504 	}	,
{	0.789 	,	-0.046 	,	1.504 	}	,
{	0.804 	,	-0.048 	,	1.504 	}	,
{	0.819 	,	-0.046 	,	1.504 	}	,
{	0.832 	,	-0.039 	,	1.504 	}	,
{	0.843 	,	-0.028 	,	1.504 	}	,
{	0.850 	,	-0.015 	,	1.504 	}	,
{	0.852 	,	0.000 	,	1.504 	}	,
{	0.850 	,	0.015 	,	1.504 	}	,
{	0.843 	,	0.028 	,	1.504 	}	,
{	0.832 	,	0.039 	,	1.504 	}	,
{	0.819 	,	0.046 	,	1.504 	}	,
{	0.804 	,	0.048 	,	1.504 	}	};
float slt2[][3] = {
{	0.804 	,	0.048 	,	1.504 	}	,
{	0.789 	,	0.046 	,	1.504 	}	,
{	0.776 	,	0.039 	,	1.504 	}	,
{	0.765 	,	0.028 	,	1.504 	}	,
{	0.758 	,	0.015 	,	1.504 	}	,
{	0.756 	,	0.000 	,	1.504 	}	,
{	0.758 	,	-0.015 	,	1.504 	}	,
{	0.765 	,	-0.028 	,	1.504 	}	,
{	0.776 	,	-0.039 	,	1.504 	}	,
{	0.789 	,	-0.046 	,	1.504 	}	,
{	0.804 	,	-0.048 	,	1.504 	}	,
{	0.819 	,	-0.046 	,	1.504 	}	,
{	0.832 	,	-0.039 	,	1.504 	}	,
{	0.843 	,	-0.028 	,	1.504 	}	,
{	0.850 	,	-0.015 	,	1.504 	}	,
{	0.852 	,	0.000 	,	1.504 	}	,
{	0.850 	,	0.015 	,	1.504 	}	,
{	0.843 	,	0.028 	,	1.504 	}	,
{	0.832 	,	0.039 	,	1.504 	}	,
{	0.819 	,	0.046 	,	1.504 	}	,
{	0.804 	,	0.048 	,	1.504 	}	};
float sltf[3];

int i = 0;
int Flag2 = 0;
void pre_c(int32_t ang[] , uint16_t *hexArray);
						
int main(void)
{  
	int j ;
	int32_t Joint[6];
  SystemInit();	//配置系统时钟为 72M 
	USART1_Config(); //USART1 配置

	uint16_t hexArray[33] = { 0x01, 0x10, 0x55, 0x8C, 0x00, 0x0C, 0x18 };
	while (1)
	{
		dof_IK(&slte[i][0] , Joint);
		pre_c(Joint , hexArray);
		for (j = 0; j < 33; j++)
		{
			Delay(600);
			USART_SendData(USART1,hexArray[j]);			
		}
		Delay(1000);
		while( !reacH( Joint ) );
		while(i>41)
		{
				Delay(5000000);		
			  Delay(5000000);	
			  Delay(5000000);	
//			if(Flag2 == 1)
//			{
				i = 0;
				while(1)
				{
					dof_IK(&slt2[i][0] , Joint);
					pre_c(Joint , hexArray);
				for (j = 0; j < 33; j++)
				{
					Delay(600);
					USART_SendData(USART1,hexArray[j]);			
				}
				Delay(1000);
				while( !reacH( Joint ) );
				while(i>20);
			}
//			}	
		}
	}	
}

void pre_c(int32_t ang[] , uint16_t *hexArray)
{
	uint16_t crc ;
	mess(ang , hexArray);
	crc = crc16(hexArray , 31);
	comb(crc , hexArray);
}

/*
stage_1 // 20
{	0.804 	,	0.096 	,	1.504 	}
{	0.774 	,	0.091 	,	1.504 	}
{	0.748 	,	0.078 	,	1.504 	}
{	0.726 	,	0.056 	,	1.504 	}
{	0.713 	,	0.030 	,	1.504 	}
{	0.708 	,	0.000 	,	1.504 	}
{	0.713 	,	-0.030 	,	1.504 	}
{	0.726 	,	-0.056 	,	1.504 	}
{	0.748 	,	-0.078 	,	1.504 	}
{	0.774 	,	-0.091 	,	1.504 	}
{	0.804 	,	-0.096 	,	1.504 	}
{	0.834 	,	-0.091 	,	1.504 	}
{	0.860 	,	-0.078 	,	1.504 	}
{	0.882 	,	-0.056 	,	1.504 	}
{	0.895 	,	-0.030 	,	1.504 	}
{	0.900 	,	0.000 	,	1.504 	}
{	0.895 	,	0.030 	,	1.504 	}
{	0.882 	,	0.056 	,	1.504 	}
{	0.860 	,	0.078 	,	1.504 	}
{	0.834 	,	0.091 	,	1.504 	}
{	0.804 	,	0.096 	,	1.504 	}
stage_2 // 10
{	0.852 	,	0.000 	,	1.504	}	,
{	0.843 	,	0.028 	,	1.504	}	,
{	0.819 	,	0.046 	,	1.504	}	,
{	0.789 	,	0.046 	,	1.504	}	,
{	0.765 	,	0.028 	,	1.504	}	,
{	0.756 	,	0.000 	,	1.504	}	,
{	0.765 	,	-0.028 	,	1.504	}	,
{	0.789 	,	-0.046 	,	1.504	}	,
{	0.819 	,	-0.046 	,	1.504	}	,
{	0.843 	,	-0.028 	,	1.504	}	,
{	0.852 	,	0.000 	,	1.504	}	}
stage_2 // 15
{	0.852 	,	0.000 	,	1.504	}	,
{	0.847 	,	0.021 	,	1.504	}	,
{	0.834 	,	0.038 	,	1.504	}	,
{	0.815 	,	0.047 	,	1.504	}	,
{	0.793 	,	0.047 	,	1.504	}	,
{	0.774 	,	0.038 	,	1.504	}	,
{	0.761 	,	0.021 	,	1.504	}	,
{	0.756 	,	0.000 	,	1.504	}	,
{	0.761 	,	-0.021 	,	1.504	}	,
{	0.774 	,	-0.038 	,	1.504	}	,
{	0.793 	,	-0.047 	,	1.504	}	,
{	0.815 	,	-0.047 	,	1.504	}	,
{	0.834 	,	-0.038 	,	1.504	}	,
{	0.847 	,	-0.021 	,	1.504	}	,
{	0.852 	,	0.000 	,	1.504	}	}

*/
